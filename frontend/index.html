<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OPENTIX Watch — 監測面板</title>
  <style>
    :root{
      --bg:#0b0c0f; --card:#151821; --muted:#9aa3b2; --text:#eef2ff; --accent:#6ea8fe; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#232737;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", Segoe UI, Roboto, Arial, sans-serif;

  /* 疊一層黑色透明漸層，把背景圖壓暗 */
  background: 
    linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), 
    url("assets/bg.jpg") no-repeat center center fixed;
  background-size: cover;

  color: var(--text);
}

    .container{max-width:1050px; margin:32px auto; padding:0 16px}
 
    .sub{color:var(--muted); font-size:12px}
   /* 面板半透明 + 毛玻璃 */
.panel {
  background: rgba(21, 24, 33, 0.7);  /* 原本 #151821，加透明度 */
  border: 1px solid rgba(35, 39, 55, 0.8);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 8px 30px rgba(0,0,0,.35);
  backdrop-filter: blur(6px); /* 毛玻璃效果，可關掉 */
}

    /* form */
    .form{display:grid; grid-template-columns:1.2fr .9fr .7fr auto; gap:10px; align-items:end}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=text], select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1117; color:var(--text); outline:none}
    input::placeholder{color:#697086}
    button{border:0; border-radius:12px; padding:10px 14px; background:var(--accent); color:#0a0b12; font-weight:700; cursor:pointer}
    button[disabled]{opacity:.5; cursor:not-allowed}

    /* tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 8px}
    .tab{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1117; color:#muted; cursor:pointer}
    .tab.active{background:#1a2030; color:#dbe4ff; border-color:#33436a}
    .tab .alias{font-weight:700}
    .tab .badge{font-size:11px; color:#aab4d0; background:#1e2433; padding:2px 6px; border-radius:999px}
    .close{opacity:.7}

    /* table */
    table{width:100%; border-collapse:collapse; margin-top:8px; overflow:hidden; border-radius:10px}
    thead th{font-size:12px; color:#a8b3cf; text-align:left; padding:10px; background:#141827; border-bottom:1px solid var(--line)}
    tbody td{padding:10px; border-bottom:1px solid var(--line);}
    tbody tr:hover{background:#121626}
    a{color:#9ec1ff; text-decoration:none}
    .muted{color:var(--muted);}
    .tag{display:inline-block; padding:3px 8px; border-radius:999px; background:#1b2030; color:#dbe6ff; font-size:12px}

    .statusbar{display:flex; gap:12px; align-items:center; margin-top:8px; color:var(--muted); font-size:12px}
    .dot{width:8px; height:8px; border-radius:999px; background:var(--ok)}
    .err{color:var(--err)}
    .btn-sm{background:#1f2937; color:#c7d2fe; border:1px solid #2b3550}


    /* history panel */
    .hist-kpis{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px}
    .kpi{background:#0f1117; border:1px solid var(--line); border-radius:12px; padding:10px}
    .kpi .label{font-size:11px; color:#a8b3cf}
    .kpi .value{font-size:18px; font-weight:800; margin-top:6px}
    .kpi .hint{font-size:11px; color:#7f8aa9; margin-top:4px}
    .sparkline-wrap{margin-top:10px; background:#0f1117; border:1px solid var(--line); border-radius:12px; padding:10px}
    .spark-title{display:flex; align-items:center; justify-content:space-between; font-size:12px; color:#a8b3cf; margin-bottom:6px}
    .spark-meta{font-size:11px; color:#7f8aa9}

    @media (max-width:820px){
      .form{grid-template-columns:1fr}
      .hist-kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
<h1>
  <div style="display:flex; align-items:center; gap:10px">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11h18M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="#9ec1ff" stroke-width="1.6"/><circle cx="8" cy="8" r="1.3" fill="#9ec1ff"/><circle cx="12" cy="8" r="1.3" fill="#9ec1ff"/><circle cx="16" cy="8" r="1.3" fill="#9ec1ff"/></svg>
    OPENTIX Watch <span class="sub">· 售票監測面板</span>
  </div>

  <!-- 右側純文字：沿用你的 JS 用的 id=onlineBadge -->
  <span id="onlineBadge" style="font-size:14px; color:var(--muted)">線上 — 人</span>
</h1>

    <div class="panel">
      <div class="form">
        <div>
          <label>活動網址（可多個，以逗號分隔）</label>
          <input id="urls" type="text" placeholder="https://www.opentix.life/event/xxxx, https://www.opentix.life/event/yyyy" />
        </div>
        <div>
          <label>別名（必填，將用於分頁標題）</label>
          <input id="alias" type="text" placeholder="例如：座無虛席" />
        </div>
        <div>
          <label>監測頻率</label>
          <select id="freq">
            <option value="24h">每天</option>  
            <option value="6h">每 6 小時</option>
            <option value="1h">每 1 小時</option>
            <option value="10m">每 10 分鐘</option>
           
           
            
          </select>
        </div>
        <div>
          <button id="add">新增並開始</button>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="statusbar">
        <span class="dot" id="liveDot"></span>
        <span id="status">尚未執行</span>

        <button class="btn-sm" id="refresh" style="margin-left:auto">立即更新</button>
      </div>

      <table id="tbl" style="display:none">
        <thead>
          <tr><th>URL</th><th>標籤</th><th>剩餘</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="errors" class="err" style="margin-top:8px"></div>
    </div>
  </div>

<script>
const API_BASE = "https://opentix-watch-1.onrender.com";
const API = `${API_BASE}/api/status`;

/*** 狀態管理：加入 history 以便累積統計 ***/
// state: { alias: { urls, freq, last, updatedAt, history: [{ts, totalRemain}], maxHistory } }
let state = loadState();
let activeAlias = Object.keys(state)[0] || null;

const $ = (q) => document.querySelector(q);
const urlsInput = $('#urls');
const aliasInput = $('#alias');
const freqSel = $('#freq');
const addBtn = $('#add');
const tabsEl = $('#tabs');
const statusEl = $('#status');
const tblEl = $('#tbl');
const tbodyEl = tblEl.querySelector('tbody');
const errEl = $('#errors');
const liveDot = $('#liveDot');

let timers = {}; // per alias interval id

/*** 新增：工具按鈕 ***/
const bar = document.querySelector('.statusbar');
const btnHistory = document.createElement('button');
btnHistory.className = 'btn-sm';
btnHistory.textContent = '查看歷史';
btnHistory.id = 'btnHistory';
const btnCSV = document.createElement('button');
btnCSV.className = 'btn-sm';
btnCSV.textContent = '匯出 CSV';
btnCSV.id = 'btnCSV';
const btnReset = document.createElement('button');
btnReset.className = 'btn-sm';
btnReset.textContent = '重置統計';
btnReset.id = 'btnReset';
const btnRefresh = $('#refresh');
bar.insertBefore(btnHistory, btnRefresh);
bar.insertBefore(btnCSV, btnRefresh);
bar.insertBefore(btnReset, btnRefresh);

/*** 歷史面板（強化版） ***/
let historyOpen = false;
const histWrap = document.createElement('div');
histWrap.id = 'histWrap';
histWrap.style.display = 'none';
histWrap.style.marginTop = '10px';
histWrap.innerHTML = `
  <div class="hist-kpis">
    <div class="kpi">
      <div class="label">近 24 小時售出</div>
      <div class="value" id="kpiSold24h">—</div>
      <div class="hint">（若為 0 可能為無變動或資料不足）</div>
    </div>
    <div class="kpi">
      <div class="label">平均速率（張/小時）</div>
      <div class="value" id="kpiAvgRate">—</div>
      <div class="hint">近 24 小時平均</div>
    </div>
    <div class="kpi">
      <div class="label">最近一次變動</div>
      <div class="value" id="kpiLastDelta">—</div>
      <div class="hint">相對上一筆</div>
    </div>
  </div>
  <div class="sparkline-wrap">
    <div class="spark-title">
      <span>剩餘張數趨勢（近 24 小時）</span>
      <span class="spark-meta" id="sparkMeta">—</span>
    </div>
    <canvas id="spark" width="960" height="160"></canvas>
  </div>
  <table id="histTbl" style="width:100%; border-collapse:collapse; margin-top:8px; border-radius:10px; display:none">
    <thead>
      <tr><th>時間</th><th>總剩餘</th><th>與前次差</th><th>估算速率(張/小時)</th></tr>
    </thead>
    <tbody></tbody>
  </table>
`;
tblEl.parentNode.appendChild(histWrap);

btnHistory.addEventListener('click', () => {
  historyOpen = !historyOpen;
  histWrap.style.display = historyOpen ? '' : 'none';
  btnHistory.textContent = historyOpen ? '收起歷史' : '查看歷史';
  if (historyOpen && activeAlias) {
    drawHistory(activeAlias);
    drawSparkline(activeAlias);
    fillKpis(activeAlias);
  }
});
btnCSV.addEventListener('click', () => { if(activeAlias) downloadCSV(activeAlias); });
btnReset.addEventListener('click', () => {
  if(!activeAlias) return;
  if(!state[activeAlias]) return;
  state[activeAlias].history = [];
  saveState();
  draw(activeAlias);
  if(historyOpen){
    drawHistory(activeAlias);
    drawSparkline(activeAlias);
    fillKpis(activeAlias);
  }
});

/*** 表單與分頁 ***/
function toggleAdd(){
  const aliasOk = aliasInput.value.trim().length>0;
  addBtn.disabled = !aliasOk;
}
aliasInput.addEventListener('input', toggleAdd);
urlsInput.addEventListener('input', toggleAdd);
addBtn.disabled = false;

addBtn.addEventListener('click', () => {
  const alias = aliasInput.value.trim();
  const urls  = urlsInput.value.trim();
  const freq  = freqSel.value;
  if(!alias){ toast('請輸入別名'); return; }
  if(!urls){ toast('請輸入至少一個活動網址'); return; }
  if(state[alias]){ toast('此別名已存在，請更換'); return; }
  state[alias] = { urls, freq, last:null, updatedAt:null, history:[], maxHistory: 2000 };
  saveState();
  aliasInput.value='';
  addBtn.disabled = true;
  renderTabs();
  setActive(alias);
  runFetch(alias);
});

function renderTabs(){
  tabsEl.innerHTML = '';
  const names = Object.keys(state);
  if(names.length===0){ statusEl.textContent = '尚未建立任何監測項目'; tblEl.style.display='none'; return; }
  names.forEach(name => {
    const t = document.createElement('div');
    t.className = 'tab' + (name===activeAlias?' active':'');
    t.innerHTML = `<span class="alias">${name}</span>
                   <span class="badge">${labelOfFreq(state[name].freq)}</span>
                   <svg class="close" data-alias="${name}" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left:6px">
                     <path d="M6 6l12 12M18 6L6 18" stroke="#7b88a8" stroke-width="1.6" stroke-linecap="round"/>
                   </svg>`;
    t.addEventListener('click', (e)=>{
      const target = e.target.closest('.close');
      if(target){
        const a = target.getAttribute('data-alias');
        removeAlias(a);
        return;
      }
      setActive(name);
    });
    tabsEl.appendChild(t);
  });
}

function setActive(name){
  activeAlias = name; renderTabs(); draw(activeAlias); setupTimer(activeAlias);
  if(historyOpen){
    drawHistory(activeAlias);
    drawSparkline(activeAlias);
    fillKpis(activeAlias);
  }
}

function removeAlias(name){
  clearTimer(name);
  delete state[name];
  saveState();
  const rest = Object.keys(state);
  activeAlias = rest[0] || null;
  renderTabs();
  draw(activeAlias);
  if(historyOpen){
    drawHistory(activeAlias);
    drawSparkline(activeAlias);
    fillKpis(activeAlias);
  }
}

/*** 視圖繪製 ***/
function draw(name){
  errEl.textContent='';
  if(!name){ statusEl.textContent='尚未建立任何監測'; tblEl.style.display='none'; return; }
  const item = state[name];
  if(!item || !item.last){
    statusEl.textContent = '尚未抓取';
    tblEl.style.display='none';
    return;
  }

  const data = item.last;
  const ts = item.updatedAt ? new Date(item.updatedAt).toLocaleString() : '';
  const total = calcTotalRemain(data);
  const { delta, ratePerHour } = summarizeHistory(item.history);

  // 狀態列摘要（拿掉「別名：」）
  statusEl.textContent = `${name} · 來源：${shorten(item.urls)} · 最後更新：${ts} · 總剩餘：${total} · 與前次差：${fmtDelta(delta)} · 速率：${fmtRate(ratePerHour)}`;
  
  // 表格
  tbodyEl.innerHTML = '';
  if(!data || !data.results || data.results.length===0){
    tblEl.style.display='none';
  }else{
    data.results.forEach(r=>{
      if(!r.entries || r.entries.length===0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(r.url)}</td><td class="muted">未偵測到「剩：xxx」</td><td>—</td>`;
        tbodyEl.appendChild(tr);
      }else{
        r.entries.forEach(e=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><a href="${r.url}" target="_blank">${new URL(r.url).hostname}</a></td>
                          <td>${e.label ? escapeHTML(e.label) : '<span class="muted">場次</span>'}</td>
                          <td><span class="tag">${escapeHTML(e.remaining)}</span></td>`;
          tbodyEl.appendChild(tr);
        });
      }
    });
    tblEl.style.display='';
  }
  if(data.errors && data.errors.length){
    errEl.textContent = data.errors.map(e=>`${e.url||''} ${e.error||e}`).join(' | ');
  }
}

function drawHistory(name){
  const item = state[name];
  const hist = (item && item.history) ? item.history : [];
  const table = document.querySelector('#histTbl');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  if(hist.length === 0){
    table.style.display = 'none';
    $('#kpiSold24h').textContent = '—';
    $('#kpiAvgRate').textContent = '—';
    $('#kpiLastDelta').textContent = '—';
    $('#sparkMeta').textContent = '尚無資料';
    const ctx = $('#spark')?.getContext('2d');
    if(ctx){ ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height); }
    return;
  }
  // 逐行列出：時間 / 總剩餘 / 與前次差 / 小時速率（對上一筆）
  for(let i=0;i<hist.length;i++){
    const cur = hist[i];
    const prev = i>0 ? hist[i-1] : null;
    const dtHours = prev ? Math.max( (cur.ts - prev.ts)/3600000, 1e-6 ) : null;
    const delta = prev ? (cur.totalRemain - prev.totalRemain) : null; // 負數代表售出
    const rate = (prev && dtHours) ? ( (prev.totalRemain - cur.totalRemain) / dtHours ) : null; // 售出/小時
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(cur.ts).toLocaleString()}</td>
      <td>${cur.totalRemain}</td>
      <td>${prev ? fmtDelta(delta) : '—'}</td>
      <td>${prev ? fmtRate(rate) : '—'}</td>
    `;
    tbody.appendChild(tr);
  }
  table.style.display = '';
}

/*** Sparkline (近 24h) ***/
function drawSparkline(name){
  const item = state[name];
  const hist = (item && item.history) ? item.history : [];
  const canvas = document.getElementById('spark');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width, canvas.height);
  if(hist.length<2){ $('#sparkMeta').textContent='資料不足'; return; }

  const cutoff = Date.now() - 24*3600_000;
  const sub = hist.filter(h => h.ts >= cutoff);
  const used = sub.length>=2 ? sub : hist.slice(-Math.min(hist.length, 30));
  if(used.length<2){ $('#sparkMeta').textContent='資料不足'; return; }

  const w = canvas.width, h = canvas.height, pad = 10;
  const xs = used.map((p,i)=> i);
  const ys = used.map(p => p.totalRemain);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const dx = (w - pad*2) / (xs.length - 1 || 1);
  const scaleY = (val)=> {
    if(maxY===minY) return h/2;
    return h - pad - ( (val - minY) / (maxY - minY) ) * (h - pad*2);
  };

  // 軸線 & 參考刻度
  ctx.globalAlpha = 0.5;
  ctx.strokeStyle = '#232737';
  ctx.beginPath();
  ctx.moveTo(pad, h - pad); ctx.lineTo(w - pad, h - pad); // x axis
  ctx.moveTo(pad, pad); ctx.lineTo(pad, h - pad); // y axis
  ctx.stroke();

  // 參考線（min / max / latest）
  ctx.font = '11px system-ui, -apple-system, sans-serif';
  ctx.fillStyle = '#7f8aa9';
  ctx.textAlign = 'left';
  ctx.fillText(`min ${minY}`, pad+6, scaleY(minY)-4);
  ctx.fillText(`max ${maxY}`, pad+6, scaleY(maxY)-4);
  ctx.fillText(`latest ${ys[ys.length-1]}`, pad+6, scaleY(ys[ys.length-1])-4);

  // 線
  ctx.globalAlpha = 1;
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#6ea8fe';
  ctx.beginPath();
  used.forEach((p,i)=>{
    const x = pad + i*dx;
    const y = scaleY(p.totalRemain);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // 結尾點
  const lastX = pad + (used.length-1)*dx;
  const lastY = scaleY(used[used.length-1].totalRemain);
  ctx.fillStyle = '#6ea8fe';
  ctx.beginPath(); ctx.arc(lastX,lastY,3,0,Math.PI*2); ctx.fill();

  // Meta
  const spanHrs = (used[used.length-1].ts - used[0].ts)/3600000;
  $('#sparkMeta').textContent = `樣本數：${used.length} · 覆蓋時長：約 ${spanHrs.toFixed(2)} 小時`;
}

/*** KPI 填值 ***/
function fillKpis(name){
  const item = state[name];
  const hist = (item && item.history) ? item.history : [];
  const { sold24h, avgRate24h } = calc24h(hist);
  const { delta } = summarizeHistory(hist);

  $('#kpiSold24h').textContent = sold24h===null ? '—' : `${sold24h}`;
  $('#kpiAvgRate').textContent = avgRate24h===null ? '—' : avgRate24h.toFixed(2);
  $('#kpiLastDelta').textContent = delta===null ? '—' : fmtDelta(delta);
}

/*** 抓取與輪詢 ***/
async function runFetch(name){
  const item = state[name];
  if(!item) return;
  errEl.textContent='';
  statusEl.textContent = `正在抓取（${name}）…`;
  liveDot.style.background = '#f59e0b'; // 黃色表示進行中
  try{
    const target = item.urls.includes(',') ? `${API}?urls=${encodeURIComponent(item.urls)}` : `${API}?url=${encodeURIComponent(item.urls)}`;
    const res = await fetch(target, { cache:'no-store' });
    const data = await res.json();

    // 更新 last 與 updatedAt
    item.last = data; 
    item.updatedAt = Date.now();

    // 寫入歷史點
    const total = calcTotalRemain(data);
    if(!item.history) item.history = [];
    item.history.push({ ts: item.updatedAt, totalRemain: total });
    const cap = Number(item.maxHistory || 2000);
    if(item.history.length > cap) item.history = item.history.slice(-cap);

    saveState();
    if(name===activeAlias) {
      draw(name);
      if(historyOpen){
        drawHistory(name);
        drawSparkline(name);
        fillKpis(name);
      }
    }
    liveDot.style.background = '#22c55e'; // 綠色表示成功
  }catch(e){
    errEl.textContent = '讀取失敗：' + e;
    statusEl.textContent = '讀取失敗';
    liveDot.style.background = '#ef4444'; // 紅色表示錯誤
  }
}

function setupTimer(name){
  // 僅保留當前分頁的輪詢
  Object.keys(timers).forEach(clearTimer);
  const item = state[name]; if(!item) return;
  const ms = freqToMs(item.freq);
  timers[name] = setInterval(()=> runFetch(name), ms);
}
function clearTimer(name){ if(timers[name]){ clearInterval(timers[name]); delete timers[name]; } }

/*** 計算與工具 ***/
function labelOfFreq(v){ 
  return v==='10m'?'每 10 分鐘'
       : v==='1h' ? '每 1 小時'
       : v==='6h' ? '每 6 小時'
       : '每天';
}
function freqToMs(v){ 
  return v==='10m' ? 10*60_000
       : v==='1h'  ? 3600_000
       : v==='6h'  ? 6*3600_000
       : 24*3600_000; 
}
function shorten(s){ return s.length>60? s.slice(0,57)+'…' : s; }
function toast(msg){ statusEl.textContent = msg; setTimeout(()=>{ if(activeAlias){ draw(activeAlias); } else { statusEl.textContent=''; } }, 1400); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

function parseRemain(val){
  // 將「剩：123」「剩餘123」「123張」等字樣轉成整數
  if(val == null) return 0;
  const n = String(val).replace(/[^\d]/g,'');
  return n ? parseInt(n,10) : 0;
}
function calcTotalRemain(data){
  if(!data || !data.results) return 0;
  let sum = 0;
  for(const r of data.results){
    if(!r.entries) continue;
    for(const e of r.entries){
      sum += parseRemain(e.remaining);
    }
  }
  return sum;
}
function summarizeHistory(hist){
  if(!hist || hist.length<2) return { delta: null, ratePerHour: null };
  const cur = hist[hist.length-1];
  const prev = hist[hist.length-2];
  const delta = cur.totalRemain - prev.totalRemain; // 負數=售出增加
  const dtH = Math.max((cur.ts - prev.ts)/3600000, 1e-6);
  const rate = (prev.totalRemain - cur.totalRemain) / dtH; // 張/小時
  return { delta, ratePerHour: rate };
}
function fmtDelta(d){
  if(d===null || d===undefined) return '—';
  if(d===0) return '0';
  return d<0 ? `${d}（售出 ${-d}）` : `+${d}`;
}
function fmtRate(r){
  if(r===null || r===undefined || isNaN(r)) return '—';
  return r.toFixed(2);
}
function calc24h(hist){
  if(!hist || hist.length<2) return { sold24h: null, avgRate24h: null };
  const cutoff = Date.now() - 24*3600_000;
  const sub = hist.filter(h => h.ts >= cutoff);
  const used = sub.length>=2 ? sub : hist.slice(-Math.min(hist.length, 30));
  if(used.length<2) return { sold24h: null, avgRate24h: null };

  // sold = 第一筆剩餘 - 最後一筆剩餘（正數代表售出）
  const sold = used[0].totalRemain - used[used.length-1].totalRemain;
  const hours = Math.max((used[used.length-1].ts - used[0].ts)/3600000, 1e-6);
  return { sold24h: sold, avgRate24h: sold/hours };
}

/*** 匯出 CSV ***/
function downloadCSV(name){
  const item = state[name];
  const hist = (item && item.history) ? item.history : [];
  if(hist.length===0){ toast('尚無歷史資料'); return; }
  const rows = [['alias','timestamp','time_local','total_remain','delta_vs_prev','rate_per_hour']];
  for(let i=0;i<hist.length;i++){
    const cur = hist[i], prev = i>0 ? hist[i-1] : null;
    const dtH = prev ? Math.max((cur.ts - prev.ts)/3600000, 1e-6) : null;
    const delta = prev ? (cur.totalRemain - prev.totalRemain) : null;
    const rate = (prev && dtH) ? ( (prev.totalRemain - cur.totalRemain)/dtH ) : null;
    rows.push([
      name,
      cur.ts,
      new Date(cur.ts).toLocaleString(),
      cur.totalRemain,
      (delta===null? '' : delta),
      (rate===null? '' : rate.toFixed(4))
    ]);
  }
  const csv = rows.map(r=>r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${name}-opentix-history.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/*** 儲存/載入 ***/
function saveState(){ localStorage.setItem('opentix_watch_state', JSON.stringify(state)); }
function loadState(){ 
  try{ 
    const obj = JSON.parse(localStorage.getItem('opentix_watch_state')||'{}');
    for(const k of Object.keys(obj)){
      obj[k].history = obj[k].history || [];
      obj[k].maxHistory = obj[k].maxHistory || 2000;
    }
    return obj;
  }catch{ return {} } 
}

/*** 初始渲染與手動更新 ***/
renderTabs(); draw(activeAlias);
if(activeAlias){ setupTimer(activeAlias); }
document.getElementById('refresh').addEventListener('click', () => { if(activeAlias) runFetch(activeAlias); });

(function(){
  const badge = document.getElementById("onlineBadge");
  const cidKey = "client_id";
  let cid = localStorage.getItem(cidKey);
  if (!cid) {
    cid = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random()));
    localStorage.setItem(cidKey, cid);
  }

  async function ping(){
    try{
        await fetch(`${API_BASE}/heartbeat`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({client_id: cid})
      });
    }catch(_){}
  }
async function refreshCount(){
  try{
    const r = await fetch(`${API_BASE}/online_count`);
    const d = await r.json();
    badge.textContent = `線上 ${d.count} 人`;
    if (d.count > 2) {
      badge.style.color = "var(--err)";   // 紅字（已在 :root 定義 #ef4444）
    } else {
      badge.style.color = "var(--muted)"; // 原本灰色
    }
  }catch(_){
    badge.textContent = "線上 N/A";
    badge.style.color = "var(--muted)";
  }
}

  ping(); refreshCount();
  setInterval(ping, 20000);
  setInterval(refreshCount, 20000);
})();



</script>

</body>
</html>
