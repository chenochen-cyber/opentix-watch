<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenTix Watch — 監測面板</title>
  <style>
    :root{
      --bg:#0b0c0f; --card:#151821; --muted:#9aa3b2; --text:#eef2ff; --accent:#6ea8fe; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#232737;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#0a0b0e,#10131a); color:var(--text)}
    .container{max-width:1050px; margin:32px auto; padding:0 16px}
    h1{display:flex; align-items:center; gap:10px; margin:0 0 16px; font-size:22px; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:12px}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.35)}

    /* form */
    .form{display:grid; grid-template-columns:1.2fr .9fr .7fr auto; gap:10px; align-items:end}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input[type=text], select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1117; color:var(--text); outline:none}
    input::placeholder{color:#697086}
    button{border:0; border-radius:12px; padding:10px 14px; background:var(--accent); color:#0a0b12; font-weight:700; cursor:pointer}
    button[disabled]{opacity:.5; cursor:not-allowed}

    /* tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:14px 0 8px}
    .tab{display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:#0f1117; color:#muted; cursor:pointer}
    .tab.active{background:#1a2030; color:#dbe4ff; border-color:#33436a}
    .tab .alias{font-weight:700}
    .tab .badge{font-size:11px; color:#aab4d0; background:#1e2433; padding:2px 6px; border-radius:999px}
    .close{opacity:.7}

    /* table */
    table{width:100%; border-collapse:collapse; margin-top:8px; overflow:hidden; border-radius:10px}
    thead th{font-size:12px; color:#a8b3cf; text-align:left; padding:10px; background:#141827; border-bottom:1px solid var(--line)}
    tbody td{padding:10px; border-bottom:1px solid var(--line);}
    tbody tr:hover{background:#121626}
    a{color:#9ec1ff; text-decoration:none}
    .muted{color:var(--muted);}
    .tag{display:inline-block; padding:3px 8px; border-radius:999px; background:#1b2030; color:#dbe6ff; font-size:12px}

    .statusbar{display:flex; gap:12px; align-items:center; margin-top:8px; color:var(--muted); font-size:12px}
    .dot{width:8px; height:8px; border-radius:999px; background:var(--ok)}
    .dot.loading{background:var(--warn)}    /* ✅ 載入中 */
    .dot.error{background:var(--err)}       /* ✅ 錯誤時 */
    .err{color:var(--err)}
    .btn-sm{background:#1f2937; color:#c7d2fe; border:1px solid #2b3550}

    @media (max-width:820px){
      .form{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 11h18M7 3h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="#9ec1ff" stroke-width="1.6"/><circle cx="8" cy="8" r="1.3" fill="#9ec1ff"/><circle cx="12" cy="8" r="1.3" fill="#9ec1ff"/><circle cx="16" cy="8" r="1.3" fill="#9ec1ff"/></svg>
      OpenTix Watch <span class="sub">· 售票監測面板</span>
    </h1>

    <div class="panel">
      <div class="form">
        <div>
          <label>活動網址（可多個，以逗號分隔）</label>
          <input id="urls" type="text" placeholder="https://www.opentix.life/event/xxxx, https://www.opentix.life/event/yyyy" />
        </div>
        <div>
          <label>別名（必填，將用於分頁標題）</label>
          <input id="alias" type="text" placeholder="例如：座無虛席" />
        </div>
        <div>
          <label>監測頻率</label>
          <select id="freq">
            <option value="1h">每 1 小時</option>
            <option value="6h">每 6 小時</option>
            <option value="24h">每天</option>
          </select>
        </div>
        <div>
          <button id="add">新增並開始</button>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="statusbar">
        <span class="dot" id="liveDot"></span>
        <span id="status">尚未執行</span>
        <button class="btn-sm" id="refresh" style="margin-left:auto">立即更新</button>
      </div>

      <table id="tbl" style="display:none">
        <thead>
          <tr><th>URL</th><th>標籤</th><th>剩餘</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="errors" class="err" style="margin-top:8px"></div>
    </div>
  </div>

<script>
const API_BASE = "https://opentix-watch-1.onrender.com"; // ← 你的後端
const API = `${API_BASE}/api/status`;

/*** 狀態管理 ***/
let state = loadState(); // { alias: { urls: string, freq: '1h'|'6h'|'24h', last: any, updatedAt: ts } }
let activeAlias = Object.keys(state)[0] || null;

const $ = (q) => document.querySelector(q);
const urlsInput = $('#urls');
const aliasInput = $('#alias');
const freqSel = $('#freq');
const addBtn = $('#add');
const tabsEl = $('#tabs');
const statusEl = $('#status');
const tblEl = $('#tbl');
const tbodyEl = tblEl.querySelector('tbody');
const errEl = $('#errors');
const liveDot = $('#liveDot');
const refreshBtn = $('#refresh');
let timers = {};               // per alias interval id
let inFlightController = null; // ✅ 取消上一個請求用

/*** 工具 ***/
function parseUrls(raw){
  // ✅ 乾淨化：分割、去空白、去空字串、基本 URL 驗證、去重
  const set = new Set();
  (raw || '').split(',').map(s=>s.trim()).forEach(s=>{
    if(!s) return;
    try{
      const u = new URL(s);
      // 最少要求含 /event/，避免貼到節目總覽頁
      if(!/\/event\//.test(u.pathname)) { /* 可視需求放寬 */ }
      set.add(u.toString());
    }catch{ /* 非法 URL 忽略 */ }
  });
  return Array.from(set);
}
function normalizeAlias(a){ return (a||'').trim().replace(/\s+/g,' '); }
function labelOfFreq(v){ return v==='1h'?'每 1 小時': (v==='6h'?'每 6 小時':'每天'); }
function freqToMs(v){ return v==='1h'? 3600_000 : (v==='6h'? 6*3600_000 : 24*3600_000); }
function shorten(s){ return s.length>60? s.slice(0,57)+'…' : s; }
function toast(msg){ statusEl.textContent = msg; setTimeout(()=>{ if(activeAlias){ draw(activeAlias); } else { statusEl.textContent=''; } }, 1400); }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function saveState(){ localStorage.setItem('opentix_watch_state', JSON.stringify(state)); }
function loadState(){ try{ return JSON.parse(localStorage.getItem('opentix_watch_state')||'{}') }catch{ return {} } }
function setDot(mode){   // ✅ 狀態燈
  liveDot.classList.remove('loading','error');
  if(mode==='loading') liveDot.classList.add('loading');
  else if(mode==='error') liveDot.classList.add('error');
}

/*** UI 初始 ***/
function toggleAdd(){
  const aliasOk = aliasInput.value.trim().length>0;
  addBtn.disabled = !aliasOk; // 只強制需要別名，按下去再檢查網址
}
aliasInput.addEventListener('input', toggleAdd);
urlsInput.addEventListener('input', toggleAdd);
addBtn.disabled = false;

/*** 新增 alias ***/
addBtn.addEventListener('click', () => {
  const aliasRaw = aliasInput.value;
  const alias = normalizeAlias(aliasRaw);
  const urlsArr = parseUrls(urlsInput.value);
  const freq  = freqSel.value;

  if(!alias){ toast('請輸入別名'); return; }
  if(urlsArr.length===0){ toast('請輸入至少一個有效的活動網址'); return; }

  // ✅ 別名唯一（大小寫不敏感）
  const hasDup = Object.keys(state).some(k => k.toLowerCase() === alias.toLowerCase());
  if(hasDup){ toast('此別名已存在，請更換'); return; }

  state[alias] = { urls: urlsArr.join(', '), freq, last:null, updatedAt:null };
  saveState();
  aliasInput.value='';
  addBtn.disabled = true;
  renderTabs();
  setActive(alias);
  runFetch(alias);
});

/*** Tabs ***/
function renderTabs(){
  tabsEl.innerHTML = '';
  const names = Object.keys(state);
  if(names.length===0){ statusEl.textContent = '尚未建立任何監測項目'; tblEl.style.display='none'; return; }
  names.forEach(name => {
    const t = document.createElement('div');
    t.className = 'tab' + (name===activeAlias?' active':'');
    t.innerHTML = `<span class="alias">${escapeHTML(name)}</span>
                   <span class="badge">${labelOfFreq(state[name].freq)}</span>
                   <svg class="close" data-alias="${escapeHTML(name)}" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left:6px" aria-label="刪除分頁">
                     <path d="M6 6l12 12M18 6L6 18" stroke="#7b88a8" stroke-width="1.6" stroke-linecap="round"/>
                   </svg>`;
    t.addEventListener('click', (e)=>{
      const closeHit = e.target.closest('.close');
      if(closeHit){
        const a = closeHit.getAttribute('data-alias');
        removeAlias(a);
        return;
      }
      setActive(name);
    });
    tabsEl.appendChild(t);
  });

  // ✅ 讓頻率下拉與目前 active 同步顯示
  if(activeAlias && state[activeAlias]) {
    freqSel.value = state[activeAlias].freq;
  }
}

function setActive(name){
  activeAlias = name;
  renderTabs();
  draw(activeAlias);
  setupTimer(activeAlias);
}

function removeAlias(name){
  clearTimer(name);
  delete state[name];
  saveState();
  const rest = Object.keys(state);
  activeAlias = rest[0] || null;
  renderTabs();
  draw(activeAlias);
}

/*** 畫表格 ***/
function draw(name){
  errEl.textContent='';
  setDot(); // 回到正常色
  if(!name){ statusEl.textContent='尚未建立任何監測'; tblEl.style.display='none'; return; }
  const item = state[name];
  if(!item || !item.last){
    statusEl.textContent = '尚未抓取';
    tblEl.style.display='none';
    return;
  }
  const data = item.last;
  const ts = item.updatedAt ? new Date(item.updatedAt).toLocaleString() : '';
  statusEl.textContent = `別名：${name} · 來源：${shorten(item.urls)} · 最後更新：${ts}`;
  tbodyEl.innerHTML = '';
  if(!data || !Array.isArray(data.results) || data.results.length===0){
    tblEl.style.display='none';
  }else{
    data.results.forEach(r=>{
      const showText = (()=>{ try{ const u=new URL(r.url); return u.hostname + u.pathname; }catch{ return r.url; }})(); // ✅ 顯示 hostname+path
      if(!r.entries || r.entries.length===0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(showText)}</td><td class="muted">未偵測到「剩：xxx」</td><td>—</td>`;
        tbodyEl.appendChild(tr);
      }else{
        r.entries.forEach(e=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><a href="${r.url}" target="_blank" rel="noopener noreferrer">${escapeHTML(showText)}</a></td>
                          <td>${e.label ? escapeHTML(e.label) : '<span class="muted">場次</span>'}</td>
                          <td><span class="tag">${escapeHTML(e.remaining)}</span></td>`;
          tbodyEl.appendChild(tr);
        });
      }
    });
    tblEl.style.display='';
  }
  if(Array.isArray(data.errors) && data.errors.length){
    errEl.textContent = data.errors.map(e=>`${e.url||''} ${e.error||e}`).join(' | ');
    setDot('error'); // ✅ 若回傳含錯誤
  }
}

/*** 請求 ***/
async function runFetch(name){
  const item = state[name];
  if(!item) return;

  // ✅ 取消上一個請求（避免狂點或頻繁輪詢堆疊）
  if(inFlightController) inFlightController.abort();
  const ac = new AbortController();
  inFlightController = ac;

  errEl.textContent='';
  statusEl.textContent = `正在抓取（${name}）…`;
  setDot('loading'); // ✅ 載入燈

  // ✅ 逾時保護（例如 20 秒）
  const timeoutId = setTimeout(()=> ac.abort(), 20000);

  try{
    // 從 state 取乾淨過的 urls
    const urlsArr = parseUrls(item.urls);
    if(urlsArr.length===0) throw new Error('沒有有效的 URL');

    const qs = (urlsArr.length>1)
      ? `?urls=${encodeURIComponent(urlsArr.join(', '))}`
      : `?url=${encodeURIComponent(urlsArr[0])}`;

    const res = await fetch(`${API}${qs}`, { cache:'no-store', signal: ac.signal });

    // ✅ 先檢查 res.ok，再決定用 json 或 text 解析
    const text = await res.text();
    if(!res.ok){
      throw new Error(`HTTP ${res.status} ${res.statusText} · ${text.slice(0,120)}`);
    }
    let data;
    try{
      data = JSON.parse(text);
    }catch{
      throw new Error('回應非有效 JSON：' + text.slice(0,200));
    }

    item.last = data; item.updatedAt = Date.now(); saveState();
    if(name===activeAlias) draw(name);
  }catch(e){
    errEl.textContent = '讀取失敗：' + (e?.message || e);
    statusEl.textContent = '讀取失敗';
    setDot('error'); // ✅ 錯誤燈
  }finally{
    clearTimeout(timeoutId);
    inFlightController = null;
  }
}

/*** 輪詢 ***/
function setupTimer(name){
  // 清掉所有舊的 interval，保持畫面上「唯一一個」分頁在輪詢
  Object.keys(timers).forEach(clearTimer);
  const item = state[name]; if(!item) return;
  const ms = freqToMs(item.freq);
  timers[name] = setInterval(()=> runFetch(name), ms);
}
function clearTimer(name){ if(timers[name]){ clearInterval(timers[name]); delete timers[name]; } }

/*** UI 行為補強 ***/
// ✅ 立即更新：補掛事件
refreshBtn.addEventListener('click', ()=>{
  if(!activeAlias){ toast('沒有可更新的項目'); return; }
  runFetch(activeAlias);
});

// ✅ 變更頻率：作用在當前分頁，並立即重置輪詢
freqSel.addEventListener('change', ()=>{
  if(!activeAlias || !state[activeAlias]) return;
  state[activeAlias].freq = freqSel.value;
  saveState();
  renderTabs();          // 更新 badge
  setupTimer(activeAlias); // 重置 interval
});

// 初始渲染
renderTabs(); draw(activeAlias);
if(activeAlias){ setupTimer(activeAlias); }
</script>
</body>
</html>
